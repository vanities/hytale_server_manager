name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend

      - name: Build frontend
        run: npm run build
        working-directory: frontend

      - name: Install server dependencies
        run: npm ci
        working-directory: server

      - name: Build server
        run: npm run build
        working-directory: server

      - name: Create release packages
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}

          # Create package directory
          mkdir -p release-package

          # Copy server dist
          cp -r server/dist release-package/

          # Copy frontend dist as public
          cp -r frontend/dist release-package/public

          # Copy Prisma files
          mkdir -p release-package/prisma
          cp server/prisma/schema.prisma release-package/prisma/
          cp -r server/prisma/migrations release-package/prisma/

          # Copy package files
          cp server/package.json release-package/
          cp server/package-lock.json release-package/

          # Copy config template
          cp server/config.json release-package/

          # Copy .env.example
          cp server/.env.example release-package/

          # Install production dependencies in release package
          cd release-package
          npm ci --omit=dev

          # Generate Prisma client
          npx prisma generate
          cd ..

          # Create data directories
          mkdir -p release-package/data/{db,logs,servers,backups}

          # Create install script for Windows
          printf '@echo off\r\necho ======================================\r\necho   Hytale Server Manager - Setup\r\necho ======================================\r\necho.\r\ncd /d "%%~dp0"\r\necho Setting up database...\r\ncall node_modules\\.bin\\prisma db push\r\necho.\r\necho Setup complete!\r\necho.\r\necho Run start.bat to launch the application.\r\npause\r\n' > release-package/install.bat

          # Create install script for Linux
          printf '#!/bin/bash\necho "======================================"\necho "  Hytale Server Manager - Setup"\necho "======================================"\necho\ncd "$(dirname "$0")"\necho "Setting up database..."\n./node_modules/.bin/prisma db push\necho\necho "Setup complete!"\necho\necho "Run ./start.sh to launch the application."\n' > release-package/install.sh
          chmod +x release-package/install.sh

          # Create start script for Windows
          printf '@echo off\r\necho ======================================\r\necho   Hytale Server Manager\r\necho ======================================\r\necho.\r\ncd /d "%%~dp0"\r\nset NODE_ENV=production\r\nset HSM_BASE_PATH=%%~dp0\r\necho Starting application...\r\necho Press Ctrl+C to stop\r\necho.\r\nnode dist\\index.js\r\necho.\r\necho Application stopped.\r\npause\r\n' > release-package/start.bat

          # Create start script for Linux
          printf '#!/bin/bash\necho "======================================"\necho "  Hytale Server Manager"\necho "======================================"\necho\ncd "$(dirname "$0")"\nexport NODE_ENV=production\nexport HSM_BASE_PATH="$(pwd)"\necho "Starting application..."\necho "Press Ctrl+C to stop"\necho\nnode dist/index.js\n' > release-package/start.sh
          chmod +x release-package/start.sh

          # Create Windows package
          cd release-package
          zip -r ../hytale-server-manager-${VERSION}-windows.zip .
          cd ..

          # Create Linux package
          tar -czvf hytale-server-manager-${VERSION}-linux.tar.gz -C release-package .

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: v${{ steps.version.outputs.VERSION }}
          tag_name: v${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## Installation

            1. Download the package for your platform
            2. Extract to your desired location
            3. Copy `.env.example` to `.env` and configure required values
            4. Run `install.bat` (Windows) or `./install.sh` (Linux) to set up the database
            5. Run `start.bat` (Windows) or `./start.sh` (Linux) to start the application
            6. Open http://localhost:3001 in your browser

            ## Requirements

            - Node.js 18 or higher
          files: |
            hytale-server-manager-${{ steps.version.outputs.VERSION }}-windows.zip
            hytale-server-manager-${{ steps.version.outputs.VERSION }}-linux.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
