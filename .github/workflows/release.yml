name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend

      - name: Build frontend
        run: npm run build
        working-directory: frontend

      - name: Install server dependencies
        run: npm ci
        working-directory: server

      - name: Build server
        run: npm run build
        working-directory: server

      - name: Create release packages
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}

          # Create package directory
          mkdir -p release-package

          # Copy server dist
          cp -r server/dist release-package/

          # Copy frontend dist as public
          cp -r frontend/dist release-package/public

          # Copy Prisma files
          mkdir -p release-package/prisma
          cp server/prisma/schema.prisma release-package/prisma/
          cp -r server/prisma/migrations release-package/prisma/

          # Copy package files
          cp server/package.json release-package/
          cp server/package-lock.json release-package/

          # Copy config template
          cp server/config.json release-package/

          # Copy .env.example
          cp server/.env.example release-package/

          # Install production dependencies in release package
          cd release-package
          npm ci --omit=dev

          # Generate Prisma client
          npx prisma generate
          cd ..

          # Create data directories
          mkdir -p release-package/data/{db,logs,servers,backups}

          # Create install script for Windows
          cat > release-package/install.bat << 'ENDBAT'
          @echo off
          :: Hytale Server Manager - Windows Installer

          cd /d "%~dp0"
          echo.
          echo ======================================
          echo   Hytale Server Manager - Setup
          echo ======================================
          echo.

          :: Check for Node.js
          echo Checking for Node.js...
          where node >nul 2>&1
          if %errorLevel% neq 0 (
              echo Node.js not found. Installing...

              :: Check for admin rights
              net session >nul 2>&1
              if %errorLevel% neq 0 (
                  echo Administrator privileges required to install Node.js.
                  echo Requesting elevation...
                  PowerShell -Command "Start-Process -FilePath '%~f0' -Verb RunAs"
                  exit /b
              )

              echo Downloading Node.js v20...
              PowerShell -Command "Invoke-WebRequest -Uri 'https://nodejs.org/dist/v20.18.1/node-v20.18.1-x64.msi' -OutFile '%TEMP%\node-installer.msi'"

              echo Installing Node.js v20...
              msiexec /i "%TEMP%\node-installer.msi" /qn

              :: Refresh PATH
              set "PATH=%ProgramFiles%\nodejs;%PATH%"

              :: Cleanup
              del "%TEMP%\node-installer.msi" 2>nul

              echo Node.js installed successfully.
              echo.
          )

          :: Verify Node.js
          node --version >nul 2>&1
          if %errorLevel% neq 0 (
              echo ERROR: Node.js installation failed or not in PATH.
              echo Please install Node.js manually from https://nodejs.org/
              echo Then run this script again.
              pause
              exit /b 1
          )

          for /f "tokens=*" %%i in ('node --version') do echo Node.js version: %%i
          echo.

          echo Checking environment configuration...
          if not exist ".env" (
              echo Creating .env from template...
              copy .env.example .env >nul
          )

          echo Generating secrets if needed...
          node -e "const fs=require('fs');const crypto=require('crypto');let env=fs.readFileSync('.env','utf8');let changed=false;if(/^JWT_SECRET=$/m.test(env)){env=env.replace(/^JWT_SECRET=$/m,'JWT_SECRET='+crypto.randomBytes(64).toString('hex'));changed=true;}if(/^JWT_REFRESH_SECRET=$/m.test(env)){env=env.replace(/^JWT_REFRESH_SECRET=$/m,'JWT_REFRESH_SECRET='+crypto.randomBytes(64).toString('hex'));changed=true;}if(/^SETTINGS_ENCRYPTION_KEY=$/m.test(env)){env=env.replace(/^SETTINGS_ENCRYPTION_KEY=$/m,'SETTINGS_ENCRYPTION_KEY='+crypto.randomBytes(16).toString('hex'));changed=true;}if(changed){fs.writeFileSync('.env',env);console.log('Generated missing secrets in .env');}else{console.log('Secrets already configured.');}"

          echo.
          echo Setting up database...
          node node_modules\prisma\build\index.js generate
          node node_modules\prisma\build\index.js migrate deploy
          echo.
          echo ======================================
          echo   Setup complete!
          echo ======================================
          echo.
          echo Run start.bat to launch the application.
          pause
          ENDBAT
          sed -i 's/^          //' release-package/install.bat
          unix2dos release-package/install.bat 2>/dev/null || sed -i 's/$/\r/' release-package/install.bat

          # Create install script for Linux
          cat > release-package/install.sh << 'ENDSH'
          #!/bin/bash
          # Hytale Server Manager - Linux Installer

          cd "$(dirname "$0")"
          echo
          echo "======================================"
          echo "  Hytale Server Manager - Setup"
          echo "======================================"
          echo

          # Check for Node.js
          echo "Checking for Node.js..."
          if ! command -v node &> /dev/null; then
              echo "Node.js not found. Installing..."

              # Check if running as root
              if [ "$EUID" -ne 0 ]; then
                  echo "Root privileges required to install Node.js."
                  echo "Please run: sudo ./install.sh"
                  exit 1
              fi

              # Detect package manager and install Node.js
              if command -v apt-get &> /dev/null; then
                  curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
                  apt-get install -y nodejs
              elif command -v yum &> /dev/null; then
                  curl -fsSL https://rpm.nodesource.com/setup_20.x | bash -
                  yum install -y nodejs
              elif command -v dnf &> /dev/null; then
                  curl -fsSL https://rpm.nodesource.com/setup_20.x | bash -
                  dnf install -y nodejs
              elif command -v pacman &> /dev/null; then
                  pacman -S --noconfirm nodejs npm
              else
                  echo "ERROR: Could not detect package manager."
                  echo "Please install Node.js 20+ manually from https://nodejs.org/"
                  exit 1
              fi

              echo "Node.js installed successfully."
              echo
          fi

          # Verify Node.js
          if ! command -v node &> /dev/null; then
              echo "ERROR: Node.js installation failed."
              echo "Please install Node.js 20+ manually from https://nodejs.org/"
              exit 1
          fi

          echo "Node.js version: $(node --version)"
          echo

          echo "Checking environment configuration..."
          if [ ! -f ".env" ]; then
              echo "Creating .env from template..."
              cp .env.example .env
          fi

          echo "Generating secrets if needed..."
          node -e "
          const fs = require('fs');
          const crypto = require('crypto');
          let env = fs.readFileSync('.env', 'utf8');
          let changed = false;
          if (/^JWT_SECRET=$/m.test(env)) {
            env = env.replace(/^JWT_SECRET=$/m, 'JWT_SECRET=' + crypto.randomBytes(64).toString('hex'));
            changed = true;
          }
          if (/^JWT_REFRESH_SECRET=$/m.test(env)) {
            env = env.replace(/^JWT_REFRESH_SECRET=$/m, 'JWT_REFRESH_SECRET=' + crypto.randomBytes(64).toString('hex'));
            changed = true;
          }
          if (/^SETTINGS_ENCRYPTION_KEY=$/m.test(env)) {
            env = env.replace(/^SETTINGS_ENCRYPTION_KEY=$/m, 'SETTINGS_ENCRYPTION_KEY=' + crypto.randomBytes(16).toString('hex'));
            changed = true;
          }
          if (changed) {
            fs.writeFileSync('.env', env);
            console.log('Generated missing secrets in .env');
          } else {
            console.log('Secrets already configured.');
          }
          "

          echo
          echo "Setting up database..."
          ./node_modules/.bin/prisma generate
          ./node_modules/.bin/prisma migrate deploy
          echo
          echo "======================================"
          echo "  Setup complete!"
          echo "======================================"
          echo
          echo "Run ./start.sh to launch the application."
          ENDSH
          sed -i 's/^          //' release-package/install.sh
          chmod +x release-package/install.sh

          # Create start script for Windows
          cat > release-package/start.bat << 'ENDBAT'
          @echo off
          echo ======================================
          echo   Hytale Server Manager
          echo ======================================
          echo.
          cd /d "%~dp0"
          set NODE_ENV=production
          set HSM_BASE_PATH=%~dp0
          echo Starting application...
          echo Press Ctrl+C to stop
          echo.
          node dist\index.js
          echo.
          echo Application stopped.
          pause
          ENDBAT
          sed -i 's/^          //' release-package/start.bat
          unix2dos release-package/start.bat 2>/dev/null || sed -i 's/$/\r/' release-package/start.bat

          # Create start script for Linux
          cat > release-package/start.sh << 'ENDSH'
          #!/bin/bash
          echo "======================================"
          echo "  Hytale Server Manager"
          echo "======================================"
          echo
          cd "$(dirname "$0")"
          export NODE_ENV=production
          export HSM_BASE_PATH="$(pwd)"
          echo "Starting application..."
          echo "Press Ctrl+C to stop"
          echo
          node dist/index.js
          ENDSH
          sed -i 's/^          //' release-package/start.sh
          chmod +x release-package/start.sh

          # Create Windows package
          cd release-package
          zip -r ../hytale-server-manager-${VERSION}-windows.zip .
          cd ..

          # Create Linux package
          tar -czvf hytale-server-manager-${VERSION}-linux.tar.gz -C release-package .

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: v${{ steps.version.outputs.VERSION }}
          tag_name: v${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## Installation

            1. Download the package for your platform
            2. Extract to your desired location
            3. Copy `.env.example` to `.env` and configure required values
            4. Run `install.bat` (Windows) or `./install.sh` (Linux) to set up the database
            5. Run `start.bat` (Windows) or `./start.sh` (Linux) to start the application
            6. Open http://localhost:3001 in your browser

            ## Requirements

            - Node.js 18 or higher
          files: |
            hytale-server-manager-${{ steps.version.outputs.VERSION }}-windows.zip
            hytale-server-manager-${{ steps.version.outputs.VERSION }}-linux.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
